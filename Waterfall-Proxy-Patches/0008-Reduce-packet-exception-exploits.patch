From 1f62f4e4c5f4605c2961aa2c7ec982bac0542902 Mon Sep 17 00:00:00 2001
From: KennyTV <kennytv@t-online.de>
Date: Fri, 13 Mar 2020 22:24:10 +0100
Subject: [PATCH] Reduce packet exception exploits


diff --git a/protocol/src/main/java/net/luminu/CachedExceptions.java b/protocol/src/main/java/net/luminu/CachedExceptions.java
new file mode 100644
index 00000000..8b349770
--- /dev/null
+++ b/protocol/src/main/java/net/luminu/CachedExceptions.java
@@ -0,0 +1,21 @@
+package net.luminu;
+
+import io.netty.handler.codec.CorruptedFrameException;
+import net.md_5.bungee.protocol.BadPacketException;
+
+public final class CachedExceptions {
+
+    public static final CorruptedFrameException CORRUPTED_FRAME = new CorruptedFrameException("CACHED") {
+        @Override
+        public synchronized Throwable fillInStackTrace() {
+            return this;
+        }
+    };
+
+    public static final BadPacketException BAD_PACKET = new BadPacketException("CACHED") {
+        @Override
+        public synchronized Throwable fillInStackTrace() {
+            return this;
+        }
+    };
+}
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/MinecraftDecoder.java b/protocol/src/main/java/net/md_5/bungee/protocol/MinecraftDecoder.java
index 6c3c7ab8..355a6e77 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/MinecraftDecoder.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/MinecraftDecoder.java
@@ -53,6 +53,7 @@ public class MinecraftDecoder extends MessageToMessageDecoder<ByteBuf>
 
                 if ( in.isReadable() )
                 {
+                    if (protocol != Protocol.GAME) throw net.luminu.CachedExceptions.BAD_PACKET; // Luminu - reduce packet exceptions
                     throw new BadPacketException( "Did not read all bytes from packet " + packet.getClass() + " " + packetId + " Protocol " + protocol + " Direction " + prot.getDirection() );
                 }
             } else
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/Varint21FrameDecoder.java b/protocol/src/main/java/net/md_5/bungee/protocol/Varint21FrameDecoder.java
index 743d65e4..9701e9b7 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/Varint21FrameDecoder.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/Varint21FrameDecoder.java
@@ -50,6 +50,6 @@ public class Varint21FrameDecoder extends ByteToMessageDecoder
             }
         }
 
-        throw new CorruptedFrameException( "length wider than 21-bit" );
+        throw net.luminu.CachedExceptions.CORRUPTED_FRAME; // Luminu - reduce packet exceptions
     }
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 29a317a7..2c17f71d 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -352,7 +352,10 @@ public class InitialHandler extends PacketHandler implements PendingConnection
                 }
                 break;
             default:
-                throw new IllegalArgumentException( "Cannot request protocol " + handshake.getRequestedProtocol() );
+                // Luminu start - reduce packet exceptions
+                bungee.getLogger().warning("Invalid protocol request: " + handshake.getRequestedProtocol());
+                ch.close();
+                // Luminu end
         }
     }
 
diff --git a/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java b/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
index 989bfd87..8fb28826 100644
--- a/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
+++ b/proxy/src/main/java/net/md_5/bungee/netty/HandlerBoss.java
@@ -124,7 +124,7 @@ public class HandlerBoss extends ChannelInboundHandlerAdapter
     {
         if ( ctx.channel().isActive() )
         {
-            boolean logExceptions = !( handler instanceof PingHandler );
+            boolean logExceptions = !( handler instanceof PingHandler || handler instanceof InitialHandler ); // Luminu - reduce packet exceptions
 
             if ( logExceptions )
             {
-- 
2.26.0.windows.1

